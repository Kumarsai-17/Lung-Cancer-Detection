{% extends "base.html" %}

{% block title %}Analysis Results - Lung Cancer Detection{% endblock %}

{% block content %}
<div class="result-header">
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-chart-pie"></i>
            Analysis Results
        </h1>
        <p class="page-description">Your lung cancer risk assessment results</p>
    </div>
</div>

<div class="result-section">
    <div class="container">
        {% if error %}
        <div class="error-card">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Analysis Error</h3>
            <p>{{ error }}</p>
            <div class="error-actions">
                <a href="{{ url_for('features') }}" class="btn-primary">
                    <i class="fas fa-redo"></i>
                    Try Again
                </a>
            </div>
        </div>
        {% else %}

        {% if result.analysis_type == 'complete' %}
        <!-- Patient Information Card -->
        <div class="patient-info-card">
            <div class="patient-header">
                <div class="patient-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="patient-details">
                    <h2>{{ result.patient_info.name }}</h2>
                    <div class="patient-meta">
                        <span><i class="fas fa-calendar"></i> Age: {{ result.patient_info.age }}</span>
                        <span><i class="fas fa-venus-mars"></i> Gender: {{ result.patient_info.gender }}</span>
                        <span><i class="fas fa-clock"></i> Analysis Date: {{ result.patient_info.date }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hybrid Result - Main Result -->
        <div class="result-card hybrid-result">
            <div class="result-header-content">
                <div class="result-icon hybrid-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="result-title">
                    {% if result.cnn_result %}
                    <h2>Hybrid AI Analysis Result</h2>
                    <p>Combined CNN (70%) + XGBoost (30%) Model</p>
                    {% else %}
                    <h2>XGBoost Analysis Result</h2>
                    <p>Feature-based Risk Assessment</p>
                    {% endif %}
                </div>
            </div>

            <div class="result-content">
                <div class="prediction-result">
                    {% set hybrid_cancer_prob = result.hybrid_result.probability.cancer %}
                    {% if hybrid_cancer_prob >= 70 %}
                    <div class="prediction-badge high-risk">
                        <i class="fas fa-exclamation-triangle"></i>
                        High Cancer Risk Detected
                    </div>
                    {% elif hybrid_cancer_prob >= 30 %}
                    <div class="prediction-badge medium-risk">
                        <i class="fas fa-exclamation-circle"></i>
                        Medium Cancer Risk Detected
                    </div>
                    {% else %}
                    <div class="prediction-badge low-risk">
                        <i class="fas fa-check-circle"></i>
                        Low Cancer Risk
                    </div>
                    {% endif %}
                </div>

                {% if result.cnn_result %}
                <div class="hybrid-weights">
                    <h4><i class="fas fa-balance-scale"></i> Model Weights</h4>
                    <div class="weight-bars">
                        <div class="weight-item">
                            <span class="weight-label">CNN Model</span>
                            <div class="weight-bar">
                                <div class="weight-fill cnn-weight" style="width: 70%"></div>
                            </div>
                            <span class="weight-value">70%</span>
                        </div>
                        <div class="weight-item">
                            <span class="weight-label">XGBoost Model</span>
                            <div class="weight-bar">
                                <div class="weight-fill xgb-weight" style="width: 30%"></div>
                            </div>
                            <span class="weight-value">30%</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="probability-section">
                    <h3><i class="fas fa-percentage"></i> {% if result.cnn_result %}Final Risk Assessment{% else %}Risk
                        Assessment{% endif %}</h3>
                    <div class="probability-bars">
                        <div class="probability-item">
                            <div class="prob-label">
                                <span>No Cancer Risk</span>
                                <span class="prob-value">{{ "%.1f"|format(result.hybrid_result.probability.no_cancer)
                                    }}%</span>
                            </div>
                            <div class="prob-bar">
                                <div class="prob-fill safe"
                                    style="width: {{ result.hybrid_result.probability.no_cancer }}%"></div>
                            </div>
                        </div>
                        <div class="probability-item">
                            <div class="prob-label">
                                <span>Cancer Risk</span>
                                <span class="prob-value">{{ "%.1f"|format(result.hybrid_result.probability.cancer)
                                    }}%</span>
                            </div>
                            <div class="prob-bar">
                                {% set cancer_prob = result.hybrid_result.probability.cancer %}
                                {% if cancer_prob >= 70 %}
                                <div class="prob-fill danger" style="width: {{ cancer_prob }}%"></div>
                                {% elif cancer_prob >= 30 %}
                                <div class="prob-fill medium" style="width: {{ cancer_prob }}%"></div>
                                {% else %}
                                <div class="prob-fill safe" style="width: {{ cancer_prob }}%"></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Model Results -->
        <div class="individual-results">
            <h3><i class="fas fa-chart-bar"></i> Individual Model Results</h3>

            <div class="models-grid">
                <!-- XGBoost Result -->
                <div class="model-result-card">
                    <div class="model-header">
                        <div class="model-icon xgb-icon">
                            <i class="fas fa-tree"></i>
                        </div>
                        <div class="model-info">
                            <h4>XGBoost Model</h4>
                            <p>Feature-based Analysis</p>
                        </div>
                    </div>
                    <div class="model-prediction">
                        {% set cancer_prob = result.xgb_result.probability.cancer %}
                        {% if cancer_prob >= 70 %}
                        <span class="model-badge high-risk">High Risk</span>
                        {% elif cancer_prob >= 30 %}
                        <span class="model-badge medium-risk">Medium Risk</span>
                        {% else %}
                        <span class="model-badge low-risk">Low Risk</span>
                        {% endif %}
                    </div>
                    <div class="model-probabilities">
                        <div class="prob-item">
                            <span>No Cancer: {{ "%.1f"|format(result.xgb_result.probability.no_cancer) }}%</span>
                        </div>
                        <div class="prob-item">
                            <span>Cancer: {{ "%.1f"|format(result.xgb_result.probability.cancer) }}%</span>
                        </div>
                    </div>
                </div>

                <!-- CNN Result -->
                {% if result.cnn_result %}
                <div class="model-result-card">
                    <div class="model-header">
                        <div class="model-icon cnn-icon">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <div class="model-info">
                            <h4>CNN Model</h4>
                            <p>Image-based Analysis</p>
                        </div>
                    </div>
                    <div class="model-prediction">
                        {% if result.cnn_result.prediction == 1 %}
                        <span class="model-badge high-risk">{{ result.cnn_result.predicted_label }}</span>
                        {% else %}
                        <span class="model-badge low-risk">{{ result.cnn_result.predicted_label }}</span>
                        {% endif %}
                    </div>
                    <div class="model-confidence">
                        <span>Confidence: {{ "%.1f"|format(result.cnn_result.confidence) }}%</span>
                    </div>
                    <div class="model-probabilities">
                        <div class="prob-item">
                            <span>No Cancer: {{ "%.1f"|format(result.cnn_result.no_cancer_probability) }}%</span>
                        </div>
                        <div class="prob-item">
                            <span>Cancer: {{ "%.1f"|format(result.cnn_result.cancer_probability) }}%</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="model-result-card disabled">
                    <div class="model-header">
                        <div class="model-icon cnn-icon">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <div class="model-info">
                            <h4>CNN Model</h4>
                            <p>No image provided</p>
                        </div>
                    </div>
                    <div class="model-prediction">
                        <span class="model-badge disabled">Not Available</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Medical Image Display -->
        {% if result.image_path %}
        <div class="image-analysis-section">
            <h3><i class="fas fa-image"></i> Medical Image Analysis</h3>
            <div class="analyzed-image-container">
                <img src="{{ url_for('static', filename=result.image_path) }}" alt="Medical Image"
                    class="analyzed-image">
            </div>
        </div>
        {% endif %}

        <!-- Patient Summary -->
        <div class="patient-summary-section">
            <h3><i class="fas fa-clipboard-list"></i> Patient Summary</h3>
            <div class="summary-grid">
                <div class="summary-card">
                    <h4><i class="fas fa-exclamation-circle"></i> Risk Factors Present</h4>
                    <div class="risk-factors">
                        {% set risk_factors = [] %}

                        {# Environmental Risk Factors #}
                        {% if result.feature_summary.air_pollution %}
                        {% set _ = risk_factors.append('Air Pollution Exposure') %}
                        {% endif %}
                        {% if result.feature_summary.dust_allergy %}
                        {% set _ = risk_factors.append('Dust Allergy') %}
                        {% endif %}
                        {% if result.feature_summary.occupational_hazards %}
                        {% set _ = risk_factors.append('Occupational Hazards') %}
                        {% endif %}

                        {# Lifestyle Risk Factors #}
                        {% if result.feature_summary.smoking %}
                        {% set _ = risk_factors.append('Smoking') %}
                        {% endif %}
                        {% if result.feature_summary.passive_smoker %}
                        {% set _ = risk_factors.append('Passive Smoking') %}
                        {% endif %}
                        {% if result.feature_summary.alcohol_use %}
                        {% set _ = risk_factors.append('Alcohol Use') %}
                        {% endif %}
                        {% if result.feature_summary.obesity %}
                        {% set _ = risk_factors.append('Obesity') %}
                        {% endif %}

                        {# Medical Risk Factors #}
                        {% if result.feature_summary.genetic_risk %}
                        {% set _ = risk_factors.append('Genetic Risk') %}
                        {% endif %}
                        {% if result.feature_summary.chronic_lung_disease %}
                        {% set _ = risk_factors.append('Chronic Lung Disease') %}
                        {% endif %}

                        {# Symptom Risk Factors #}
                        {% if result.feature_summary.chest_pain %}
                        {% set _ = risk_factors.append('Chest Pain') %}
                        {% endif %}
                        {% if result.feature_summary.coughing_of_blood %}
                        {% set _ = risk_factors.append('Coughing Blood') %}
                        {% endif %}
                        {% if result.feature_summary.fatigue %}
                        {% set _ = risk_factors.append('Fatigue') %}
                        {% endif %}
                        {% if result.feature_summary.weight_loss %}
                        {% set _ = risk_factors.append('Weight Loss') %}
                        {% endif %}
                        {% if result.feature_summary.shortness_of_breath %}
                        {% set _ = risk_factors.append('Shortness of Breath') %}
                        {% endif %}
                        {% if result.feature_summary.wheezing %}
                        {% set _ = risk_factors.append('Wheezing') %}
                        {% endif %}
                        {% if result.feature_summary.swallowing_difficulty %}
                        {% set _ = risk_factors.append('Swallowing Difficulty') %}
                        {% endif %}
                        {% if result.feature_summary.clubbing_of_finger_nails %}
                        {% set _ = risk_factors.append('Clubbing of Finger Nails') %}
                        {% endif %}
                        {% if result.feature_summary.frequent_cold %}
                        {% set _ = risk_factors.append('Frequent Cold') %}
                        {% endif %}
                        {% if result.feature_summary.dry_cough %}
                        {% set _ = risk_factors.append('Dry Cough') %}
                        {% endif %}
                        {% if result.feature_summary.snoring %}
                        {% set _ = risk_factors.append('Snoring') %}
                        {% endif %}

                        {# Display risk factors #}
                        {% if risk_factors %}
                        {% for factor in risk_factors %}
                        <span class="risk-factor-tag">{{ factor }}</span>
                        {% endfor %}
                        {% else %}
                        <span class="no-factors">No significant risk factors identified</span>
                        {% endif %}
                    </div>
                </div>

                <div class="summary-card">
                    <h4><i class="fas fa-shield-alt"></i> Protective Factors</h4>
                    <div class="protective-factors">
                        {% set protective_factors = [] %}

                        {# Positive protective factors (when checked) #}
                        {% if result.feature_summary.balanced_diet %}
                        {% set _ = protective_factors.append('Balanced Diet') %}
                        {% endif %}

                        {# Negative protective factors (when NOT checked) #}
                        {% if not result.feature_summary.smoking %}
                        {% set _ = protective_factors.append('Non-Smoker') %}
                        {% endif %}
                        {% if not result.feature_summary.passive_smoker %}
                        {% set _ = protective_factors.append('No Passive Smoking') %}
                        {% endif %}
                        {% if not result.feature_summary.alcohol_use %}
                        {% set _ = protective_factors.append('No Alcohol Use') %}
                        {% endif %}
                        {% if not result.feature_summary.obesity %}
                        {% set _ = protective_factors.append('Healthy Weight') %}
                        {% endif %}
                        {% if not result.feature_summary.air_pollution %}
                        {% set _ = protective_factors.append('Clean Air Environment') %}
                        {% endif %}
                        {% if not result.feature_summary.occupational_hazards %}
                        {% set _ = protective_factors.append('Safe Work Environment') %}
                        {% endif %}
                        {% if not result.feature_summary.genetic_risk %}
                        {% set _ = protective_factors.append('No Genetic Risk') %}
                        {% endif %}
                        {% if not result.feature_summary.chronic_lung_disease %}
                        {% set _ = protective_factors.append('No Chronic Lung Disease') %}
                        {% endif %}

                        {# Display protective factors #}
                        {% if protective_factors %}
                        {% for factor in protective_factors %}
                        <span class="protective-factor-tag">{{ factor }}</span>
                        {% endfor %}
                        {% else %}
                        <span class="no-factors">No significant protective factors identified</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="result-card">
            {% if result.analysis_type == 'features' %}
            <div class="result-header-content">
                <div class="result-icon">
                    <i class="fas fa-list-check"></i>
                </div>
                <div class="result-title">
                    <h2>Feature-Based Analysis</h2>
                    <p>XGBoost Model Results</p>
                </div>
            </div>

            <div class="result-content">
                <div class="prediction-result">
                    {% if result.prediction == 1 %}
                    <div class="prediction-badge high-risk">
                        <i class="fas fa-exclamation-triangle"></i>
                        High Risk Detected
                    </div>
                    {% else %}
                    <div class="prediction-badge low-risk">
                        <i class="fas fa-check-circle"></i>
                        Low Risk Detected
                    </div>
                    {% endif %}
                </div>

                <div class="probability-section">
                    <h3><i class="fas fa-percentage"></i> Risk Probability</h3>
                    <div class="probability-bars">
                        <div class="probability-item">
                            <div class="prob-label">
                                <span>No Cancer Risk</span>
                                <span class="prob-value">{{ "%.1f"|format(result.probability.no_cancer) }}%</span>
                            </div>
                            <div class="prob-bar">
                                <div class="prob-fill safe" style="width: {{ result.probability.no_cancer }}%"></div>
                            </div>
                        </div>
                        <div class="probability-item">
                            <div class="prob-label">
                                <span>Cancer Risk</span>
                                <span class="prob-value">{{ "%.1f"|format(result.probability.cancer) }}%</span>
                            </div>
                            <div class="prob-bar">
                                <div class="prob-fill danger" style="width: {{ result.probability.cancer }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% elif result.analysis_type == 'image' %}
            <div class="result-header-content">
                <div class="result-icon">
                    <i class="fas fa-image"></i>
                </div>
                <div class="result-title">
                    <h2>Image-Based Analysis</h2>
                    <p>CNN Model Results</p>
                </div>
            </div>

            <div class="result-content">
                <div class="image-result-section">
                    <div class="analyzed-image">
                        <img src="{{ url_for('static', filename=result.image_path) }}" alt="Analyzed Image">
                    </div>
                    <div class="image-analysis">
                        <div class="prediction-result">
                            {% set cancer_terms = ['cancer', 'carcinoma', 'malignant', 'tumor', 'tumour',
                            'adenocarcinoma', 'squamous', 'large_cell'] %}
                            {% set is_cancer = false %}
                            {% for term in cancer_terms %}
                            {% if term in result.predicted_label.lower() %}
                            {% set is_cancer = true %}
                            {% endif %}
                            {% endfor %}

                            <div class="prediction-badge {{ 'high-risk' if is_cancer else 'low-risk' }}">
                                <i class="fas fa-{{ 'exclamation-triangle' if is_cancer else 'check-circle' }}"></i>
                                {{ result.predicted_label }}
                            </div>
                        </div>
                        <div class="confidence-section">
                            <h4><i class="fas fa-brain"></i> AI Confidence</h4>
                            <div class="confidence-meter">
                                <div class="confidence-fill" style="width: {{ result.confidence }}%"></div>
                                <span class="confidence-text">{{ "%.1f"|format(result.confidence) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="result-disclaimer">
                <div class="disclaimer-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="disclaimer-content">
                    <h4>Important Disclaimer</h4>
                    <p>This analysis is for informational purposes only and should not replace professional medical
                        advice.
                        Please consult with a qualified healthcare provider for proper diagnosis and treatment.</p>
                </div>
            </div>

            <div class="result-actions">
                <a href="{{ url_for('features') }}" class="btn-secondary">
                    <i class="fas fa-redo"></i>
                    New Analysis
                </a>
                <button onclick="window.print()" class="btn-outline">
                    <i class="fas fa-print"></i>
                    Print Results
                </button>
                <button onclick="shareResults()" class="btn-outline">
                    <i class="fas fa-share"></i>
                    Share Results
                </button>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div class="recommendations-section">
            <h3><i class="fas fa-lightbulb"></i> Recommendations</h3>
            <div class="recommendations-grid">
                <div class="recommendation-card">
                    <i class="fas fa-user-md"></i>
                    <h4>Consult a Doctor</h4>
                    <p>Schedule an appointment with a pulmonologist for professional evaluation</p>
                </div>
                <div class="recommendation-card">
                    <i class="fas fa-heartbeat"></i>
                    <h4>Regular Checkups</h4>
                    <p>Maintain regular health screenings and follow-up appointments</p>
                </div>
                <div class="recommendation-card">
                    <i class="fas fa-leaf"></i>
                    <h4>Healthy Lifestyle</h4>
                    <p>Maintain a balanced diet, exercise regularly, and avoid smoking</p>
                </div>
                <div class="recommendation-card">
                    <i class="fas fa-shield-alt"></i>
                    <h4>Risk Reduction</h4>
                    <p>Minimize exposure to pollutants and occupational hazards</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'Lung Cancer Analysis Results',
                text: 'Check out my lung cancer risk analysis results from LungCare AI',
                url: window.location.href
            });
        } else {
            // Fallback for browsers that don't support Web Share API
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Results URL copied to clipboard!');
            });
        }
    }
</script>
{% endblock %}